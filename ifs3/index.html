<!DOCTYPE html>
<html>
    <head>
        <title>IFS Image Evolution, Take 3</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="image.js"></script>
        <script src="ifs.js"></script>
        <script src="../js/jquery.min.js"></script>
        <script src="../js/jquery.flot.js"></script>
    </head>
    
    <body>
        <div>
            <div>
                <img id="sourceImage" src="vv.jpg" />
                <canvas id="targetCanvas"></canvas>
                <canvas id="bestCanvas"></canvas>
                <canvas id="progressCanvas"></canvas>
            </div>
            
            <progress id="genProg"></progress>
        </div>
        
        <div id="statsPlot" style="width:600px;height:200px;"></div>
        
        <div>
            <input id="largeWidth" value="640">
            <input id="largeHeight" value="480" />
            <button id="largeBtn" onclick="renderLarge();">start</button>
            <canvas id="largeCanvas"></canvas>
            <img id="largeImage" alt="Right Click to Save me" src=""/>
        </div>
        
        <script>
            "use strict";
            
            var bestIfs = null;
            var bestFitness = 0;
            var workerCount = 7;
            var popSize = 1024;
            var jobSize = 0;
            var genProg = document.getElementById("genProg");
            var largeBtn = document.getElementById("largeBtn");
            var srcImage = document.getElementById("sourceImage");
            var pCanvas = document.getElementById("progressCanvas");
            var bCanvas = document.getElementById("bestCanvas");
            var lCanvas = document.getElementById("largeCanvas");
            
            var statsDataMin = new Array();
            var statsDataAvg = new Array();
            var statsDataMax = new Array();
            
            srcImage.onload = function() {
                var target = imageFromDocument(this);
                target.paint(document.getElementById("targetCanvas"));
                start(target);
            }
            
            var workers = [];
            var todo = [];
            var done = [];
            var population = [];
            var generation = 0;
            
            var stopRender = true;
            var renderWorker = new Worker("renderWorker.js");
            renderWorker.onmessage = function(msg) {
                var img = new Image(msg.data);
                img.paint(lCanvas);
                
                if (!stopRender) {
                    renderWorker.postMessage({'cmd' : 'pass'});
                }
            }
            
            function renderLarge() {
                stopRender = !stopRender;
                
                if (stopRender) {
                    largeBtn.innerHTML = 'start';
                    window.open(lCanvas.toDataURL());
//                    document.getElementById("largeImage").src = lCanvas.toDataURL();
                } else {
                    largeBtn.innerHTML = 'done';
                    
                    renderWorker.postMessage({
                        'cmd' : 'init',
                        'width' : document.getElementById("largeWidth").value,
                        'height' : document.getElementById("largeHeight").value,
                        'ifs' : bestIfs.data
                    });
                }
            }
            
            function updatePlot() {
                var min = population[population.length - 1].fitness;
                var max = population[0].fitness;
                var sum = 0;
    
                for (var i=0; i < population.length; i++) {
                    sum += population[i].fitness;
                }
                
                statsDataMin.push([generation, min]);
                statsDataAvg.push([generation, sum / population.length]);
                statsDataMax.push([generation, max]);
                
                $.plot($("#statsPlot"), [
                    {
                        label   : "max",
                        data    : statsDataMax
                    }, {
                        label   : "avg",
                        data    : statsDataAvg
                    }, {
                        label   : "min",
                        data    : statsDataMin,
                    }
                ], {
                    legend      : { position : "se" }
                });
            }
            
            function sendToWorker(w, ifs) {
                w.postMessage({
                    'cmd' : 'eval',
                    'ifs' : ifs.data
                });
            }
            
            function nextGeneration() {
                population = population.concat(done);
                done = [];
                population.sort(function (i1, i2) {
                    return i2.fitness - i1.fitness;
                });
                
                population = population.slice(0, popSize);
                
                /* breed new individuals */
                
                for (var i=0; i < popSize / 5; i++) {
                    var parent = population[i].ifs.clone();
                    parent.mutate((1 - population[i].fitness / 100) * 2);
                    todo.push(parent);
                }
                
                for (i=0; i < popSize / 5; i++) {
                    var oidx = Math.floor(Math.random() * popSize);
                    var other = population[oidx].ifs;
                    var me = population[i].ifs;
                    todo.push(me.crossover(other));
                }
                
                updatePlot();
                launchWorkers();
                generation++;
            }
            
            function launchWorkers() {
                jobSize = todo.length;
                genProg.max = jobSize;
                
                for (var i=0; i < workers.length; i++) {
                    sendToWorker(workers[i], todo.pop());
                    if (todo.length == 0) break;
                }
            }
            
            function onEvalMessage(msg) {
                var evaluated = new Evaluated(
                    new Ifs(msg.data.ifs),
                    msg.data.fitness,
                    new Image(msg.data.image));

                if (todo.length > 0) {
                    sendToWorker(this, todo.pop());
                }

                done.push(evaluated);
                genProg.value = done.length;
                var img = evaluated.image;
                img.paint(pCanvas);

                if (evaluated.fitness > bestFitness) {
                    bestIfs = evaluated.ifs;
                    bestFitness = evaluated.fitness;
                    img.paint(bCanvas);
                }

                if (done.length == jobSize) {
                    nextGeneration();
                }
            }
            
            function start(target) {
                for (var i=0; i < workerCount; i++) {
                    var w = new Worker("evalWorker.js");
                    workers.push(w);
                    w.onmessage = onEvalMessage;
                    
                    w.postMessage({
                        'cmd' : 'init',
                        'image' : target.data
                    });
                }
                
                for (i=0; i < popSize; i++) {
                    todo.push(randomIfs(64));
                }
                
                launchWorkers();
            }
            
        </script>
    </body>
</html>
